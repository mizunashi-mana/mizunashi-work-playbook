import "mizunashi.work/pkg/cue_vars/vagrant"
import "mizunashi.work/pkg/vagrant_private_ca"

import "mizunashi.work/pkg/roles/nftables"
import "mizunashi.work/pkg/roles/nginx"
import "mizunashi.work/pkg/roles/mastodon"
import "mizunashi.work/pkg/roles/nginx_exporter"
import "mizunashi.work/pkg/roles/redis_exporter"
import "mizunashi.work/pkg/roles/postgres_exporter"
import "mizunashi.work/pkg/roles/statsd_exporter"
import "mizunashi.work/pkg/roles/openssl_ocsp_responder"
import "mizunashi.work/pkg/roles/nginx_site_http_redirector"
import "mizunashi.work/pkg/roles/nginx_site_mastodon_front"
import "mizunashi.work/pkg/roles/nginx_site_local_proxy"
import "mizunashi.work/pkg/roles/nginx_site_private_ca"
import "mizunashi.work/pkg/roles/postgresql_mastodon"
import "mizunashi.work/pkg/roles/private_mastodon_certificate"

#Schema: vagrant
#Schema: nginx
#Schema: mastodon
#Schema: openssl_ocsp_responder
#Schema: nginx_exporter
#Schema: redis_exporter
#Schema: postgres_exporter
#Schema: statsd_exporter
#Schema: nginx_site_http_redirector
#Schema: nginx_site_mastodon_front
#Schema: nginx_site_local_proxy
#Schema: nginx_site_private_ca
#Schema: postgresql_mastodon
#Schema: private_mastodon_certificate
#Schema: enable_private_mastodon_certificate: bool

let ssh_port = vagrant.#ssh_port
let http_port = 80
let https_port = 443
let local_proxy_https_port = 19100

let ocsp_responder_port_for_root = 4211
let ocsp_responder_port_for_inter_tls = 4212

#Schema & {
  mastodon_local_domain: "mstdn-local.mizunashi.work"
  nginx_site_private_ca_domain: "ca-local.mizunashi.work"

  nginx_site_http_redirector_listen_port: http_port
  nginx_site_private_ca_listen_port: http_port
  nginx_site_mastodon_front_listen_port: https_port
  nginx_site_local_proxy_listen_port: local_proxy_https_port

  nftables_accept_tcp_ports: [
    ssh_port,
    http_port,
    https_port,
  ]

  nftables_accept_ports_with_addrs: {
    "to_internal": {
      source_addrs: [vagrant.#internal_host_info.ip]
      tcp_ports: [
        local_proxy_https_port
      ]
    }
  }

  nginx_site_local_proxy_common_domain: "mizunashi-local.private"
  nginx_site_local_proxy_entries: {
    "node": {
      upstream_port: #Schema.node_exporter_listen_port
    }
    "nginx": {
      upstream_port: #Schema.nginx_exporter_listen_port
    }
    "redis": {
      upstream_port: #Schema.redis_exporter_listen_port
    }
    "postgresql": {
      upstream_port: #Schema.postgres_exporter_listen_port
    }
    "statsd": {
      upstream_port: #Schema.statsd_exporter_web_listen_port
    }
  }

  openssl_ocsp_responder_entries: {
    "rootCA": {
      listen_port: ocsp_responder_port_for_root
      ca_cert: vagrant_private_ca.root_ca_certificate
      ca_privkey: vagrant_private_ca.root_ca_privkey
      ca_database_content: vagrant_private_ca.root_ca_database
    }
    "interCA_TLS": {
      listen_port: ocsp_responder_port_for_inter_tls
      ca_cert: vagrant_private_ca.inter_tls_ca_certificate
      ca_privkey: vagrant_private_ca.inter_tls_ca_privkey
      ca_database_content: vagrant_private_ca.inter_tls_ca_database
    }
  }

  nginx_resolver: "8.8.8.8"

  mastodon_single_user_mode: "true"

  enable_private_mastodon_certificate: true

  mastodon_db_user_password: {
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      65333663363039383963396135643335373032636437653730356635613734303434336534323136
      3135363037306231643964396337663435643266633566340a616137393839323333353332626462
      61383633343664306232393766613635303962303237626231333734313236646562626261386130
      3263663039376435390a383532326435363036646533393639356536626539333530343835653961
      30333436616561303861653761613238316162316430626664326662646135643737
      """
  }

  mastodon_secret_key_base: {
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      37323735323835666638353864626536386338613863303661353730646536393933363461383966
      6336356634633339333663626633333332613531303335360a396261366231393265646533323662
      30356632643331356139306366663836346663666465353766613435373330396464366530363933
      6537373534666665340a663637613064373063363437653433663365393161643538306537316664
      62386238663461633337623834633333393533636539373862303430396434616232353261303535
      66343935303935333730376362313135353265326565303864393664326235353535373235316365
      35363361623862323937633534383634343131303365623737343435363337656161363634386138
      38306135346363316432663163353565353930366462373131646264373930303964636165653530
      36303465343339366666613431323330396666373533666331646334613231346264356164636265
      37656131303933383936636166323733346130356635343839663336376136303336353662633637
      313237396237633536333036346435313630
      """
  }
  mastodon_otp_secret: {
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      35653533633464366161633961323035323261643130386638626237346261643763346464613933
      3832646163646264303434626237386533666638383336660a353939396531646333643065393263
      61626465323632633233346132646265346635616561636536376430323932373661343132623261
      3565613431656666620a363431626161303466383235366432393734323961666331306532616366
      35613137323564303033636530616239336133373361616165316131663934646661336666343031
      64653463373336386639333331396431316135313139636630386435316265366139363361656537
      39636161336439383239313532333363373565396364663461636532303035336461643635633165
      33333133653561363334356530333335663932623061366366616262306263626539636132393133
      38376363333334663861623962643166326538616534616338643833613365336639396130616465
      62393836353437303237393465633633663934613130316532386532333064386538366439656134
      386263386436623762363665373966386436
      """
  }

  mastodon_vapid_private_key: {
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      34633130343535333432333436613738373337356433336238616161313239376530383663366130
      3732656338646634656263636632616461663136336234390a356665633565653131343937326330
      61646133633061323164376165666231393234373266643836656561663838393735393738303037
      6665306434633234340a306362396535306464386232333332633739366139383430366266343930
      65333436343931616230393361653234376438313764333937616330353464373132373861356465
      3565323135626462313931613335633363643938396262373962
      """
  }
  mastodon_vapid_public_key: "BMRVNeG8Io07OP2yGLhhhIXiX-m7Tjjhws_RJ9b1BvBXTKj8wRn9XAyRBoeM04TUgj26qkdnrtBbcRh_XODZW3k="

  private_mastodon_certificate_fullchain:
    """
    -----BEGIN CERTIFICATE-----
    MIIEBjCCA4ygAwIBAgIBATAKBggqhkjOPQQDBDB+MQswCQYDVQQGEwJKUDEOMAwG
    A1UECAwFVG9reW8xCjAIBgNVBAcMAS4xEDAOBgNVBAoMB1ByaXZhdGUxIDAeBgNV
    BAsMF21penVuYXNoaS13b3JrLXBsYXlib29rMR8wHQYDVQQDDBZWYWdyYW50IFBy
    aXZhdGUgVExTIENBMB4XDTIzMDQwMjA2MjkxMloXDTI0MDQwMTA2MjkxMlowgYIx
    CzAJBgNVBAYTAkpQMQ4wDAYDVQQIDAVUb2t5bzEKMAgGA1UEBwwBLjEQMA4GA1UE
    CgwHUHJpdmF0ZTEgMB4GA1UECwwXbWl6dW5hc2hpLXdvcmstcGxheWJvb2sxIzAh
    BgNVBAMMGm1zdGRuLWxvY2FsLm1penVuYXNoaS53b3JrMHYwEAYHKoZIzj0CAQYF
    K4EEACIDYgAEJ6zwfix0S3F9L7czVdM0r2HFmgRT4r3uMuxlz+s/TslgUDdl+v2K
    G5MlpPhdkz1inW7iqtuYiMovF+jXHHQ5T+oDX85DQx6MtGDzVzS4Nt5JqZnLGjBL
    Q4pkzANgW6m5o4IB1zCCAdMwHQYDVR0OBBYEFJcd/az1kPmUXWBNYYXhOxpIGBLV
    MIGrBgNVHSMEgaMwgaCAFI9q+zWazUgtDnDwkqSef4dIqR+UoYGEpIGBMH8xCzAJ
    BgNVBAYTAkpQMQ4wDAYDVQQIDAVUb2t5bzEKMAgGA1UEBwwBLjEQMA4GA1UECgwH
    UHJpdmF0ZTEgMB4GA1UECwwXbWl6dW5hc2hpLXdvcmstcGxheWJvb2sxIDAeBgNV
    BAMMF1ZhZ3JhbnQgUHJpdmF0ZSBSb290IENBggEBMAkGA1UdEwQCMAAwDgYDVR0P
    AQH/BAQDAgeAMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjCBiAYIKwYB
    BQUHAQEEfDB6MDwGCCsGAQUFBzABhjBodHRwOi8vY2EtbG9jYWwubWl6dW5hc2hp
    LndvcmsvaW50ZXJDQV9UTFMub2NzcC8wOgYIKwYBBQUHMAKGLmh0dHA6Ly9jYS1s
    b2NhbC5taXp1bmFzaGkud29yay9pbnRlckNBX1RMUy5jcnQwPwYDVR0fBDgwNjA0
    oDKgMIYuaHR0cDovL2NhLWxvY2FsLm1penVuYXNoaS53b3JrL2ludGVyQ0FfVExT
    LmNybDAKBggqhkjOPQQDBANoADBlAjEA2KJbJE71dswIytiiNh+HzgzCmvaOQQ5/
    eTE5hF0EgeK5iUSwV+ufYyALFAREsmehAjBWQUjgwmQChzkbEK0ziQ1RB5wEpKWy
    pBP4iDtkUrWkGok3A/a1/LSBnr6xJWV90XY=
    -----END CERTIFICATE-----
    \(vagrant_private_ca.inter_tls_ca_certificate)
    """
  private_mastodon_certificate_chain: vagrant_private_ca.inter_tls_ca_certificate
  private_mastodon_certificate_privkey:
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      38343436663032646662626362386533316634366234613361336538323338363338663031373332
      3662633062613034373130343133623065396131616464390a626666633964303233333135613337
      39623364623233393464386665396532653736643238316362336666383665613435366465623030
      3431326634343739610a383434653263373162343238383635616637643665313432353238303364
      39333462356132303162666661656237636439623464326138336438326239326330613537623334
      64373037653332363261666336333833303466343238613763333932373161303564353437613862
      37613765653939376330313930656537326636646661383436633334393363633863393137323234
      33666335616537623438333765666236656131326234316634633937616365363030383133343165
      31323834306632656331336262663935363137343031346263336237386165653835653566383866
      32376463656635306364653765353635343062363134383537333038623564333662323837356561
      39303763636664346661666262613739623935346537333666633539663265636431386136613133
      65306164376635653762323834313332623238363932653237613763326134373230303133623865
      38663634643462623831333362363566366236616466633139623766333934366466643966383061
      34373430626638613733393535353563313531656166363662646361626334326632373635633038
      33393666313333396133323839316535366133396538383864383264653233316134303261613932
      32383432666261306136363866366431653131316138613035386233653331393665316461666138
      61363261666239383564663534356562656163303135373364393763356536663362396532636534
      30333630383537666433376634633064313535356562653232383464333234633964616438306133
      36653965396639386665613131313034343666653239616230326334633736616461396562626437
      39306236373939383632
      """

  nginx_site_private_ca_root_certificate: vagrant_private_ca.root_ca_certificate
  nginx_site_private_ca_root_crl: vagrant_private_ca.root_ca_crl

  nginx_site_private_ca_inter_tls_certificate: vagrant_private_ca.inter_tls_ca_certificate
  nginx_site_private_ca_inter_tls_crl: vagrant_private_ca.inter_tls_ca_crl

  nginx_site_local_proxy_certificate_fullchain:
    """
    -----BEGIN CERTIFICATE-----
    MIIEKzCCA7GgAwIBAgIBAjAKBggqhkjOPQQDBDB+MQswCQYDVQQGEwJKUDEOMAwG
    A1UECAwFVG9reW8xCjAIBgNVBAcMAS4xEDAOBgNVBAoMB1ByaXZhdGUxIDAeBgNV
    BAsMF21penVuYXNoaS13b3JrLXBsYXlib29rMR8wHQYDVQQDDBZWYWdyYW50IFBy
    aXZhdGUgVExTIENBMB4XDTIzMDQwMjA2MzIyNFoXDTI0MDQwMTA2MzIyNFowgYEx
    CzAJBgNVBAYTAkpQMQ4wDAYDVQQIDAVUb2t5bzEKMAgGA1UEBwwBLjEQMA4GA1UE
    CgwHUHJpdmF0ZTEgMB4GA1UECwwXbWl6dW5hc2hpLXdvcmstcGxheWJvb2sxIjAg
    BgNVBAMMGSoubWl6dW5hc2hpLWxvY2FsLnByaXZhdGUwdjAQBgcqhkjOPQIBBgUr
    gQQAIgNiAAS0kE/+VBJ6unAzpreXZMHuMMDy3u4zYNu6xk3+2taQiXIsVmRzEinR
    Yjpy5OPsljnS5fQCOjuvyJujt2aiCbX//Xv/MwFixV7hR5Pbb7BrjH5W8P1nsvoo
    PnggdHoVPMOjggH9MIIB+TAdBgNVHQ4EFgQUg2XzALQA89J/SZOH4FOzRiRmjUEw
    gasGA1UdIwSBozCBoIAUj2r7NZrNSC0OcPCSpJ5/h0ipH5ShgYSkgYEwfzELMAkG
    A1UEBhMCSlAxDjAMBgNVBAgMBVRva3lvMQowCAYDVQQHDAEuMRAwDgYDVQQKDAdQ
    cml2YXRlMSAwHgYDVQQLDBdtaXp1bmFzaGktd29yay1wbGF5Ym9vazEgMB4GA1UE
    AwwXVmFncmFudCBQcml2YXRlIFJvb3QgQ0GCAQEwCQYDVR0TBAIwADAOBgNVHQ8B
    Af8EBAMCB4AwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMIGIBggrBgEF
    BQcBAQR8MHowPAYIKwYBBQUHMAGGMGh0dHA6Ly9jYS1sb2NhbC5taXp1bmFzaGku
    d29yay9pbnRlckNBX1RMUy5vY3NwLzA6BggrBgEFBQcwAoYuaHR0cDovL2NhLWxv
    Y2FsLm1penVuYXNoaS53b3JrL2ludGVyQ0FfVExTLmNydDA/BgNVHR8EODA2MDSg
    MqAwhi5odHRwOi8vY2EtbG9jYWwubWl6dW5hc2hpLndvcmsvaW50ZXJDQV9UTFMu
    Y3JsMCQGA1UdEQQdMBuCGSoubWl6dW5hc2hpLWxvY2FsLnByaXZhdGUwCgYIKoZI
    zj0EAwQDaAAwZQIwUljHR/FrIX919Dy2uoviWSRHeT0l6bcLfI0sNL1DQQ+jli9p
    be7kYYR7gNl+BddJAjEAwyVXgQN7l6sA5yYc1gpp6rGtEC2L7trhdmN081vnHqil
    BsRe+pqoOu+zDWHnpu9o
    -----END CERTIFICATE-----
    \(vagrant_private_ca.inter_tls_ca_certificate)
    """
  nginx_site_local_proxy_certificate_chain: vagrant_private_ca.inter_tls_ca_certificate
  nginx_site_local_proxy_certificate_privkey:
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      33636237373433333034626531333864316263313564393462656236386132393364316232646236
      6437353664396365626161666539646230343238306133640a623638653536643934626434373136
      37653839396238313332333861393134643035353035396432623938346564343238656534353135
      6434343836313732300a353436633434636239383238313962643336633163643562653633623362
      64313864343738366234653834386662646539633333663265343734396532353966323065656236
      35303439353961363038373432346135653438303130653038323365656137336366663934303266
      63626365336264393135666264373061303930306332656539396265373938663839633035336530
      38643361633037356465663839316435303237633334396330616262346562373139646134653065
      38666237356130393738643837663732363735386237353831393136623839643435393562633833
      62386630353332653033376462326438383264623864393535336231666661646565643033663636
      62656138336564306238633132366362353433303839656431313935316433353036303663366463
      36663266313232323536346161333465366530326438366463633936393334353838633162343836
      37396434633835333236626264323031663632353663323461316666313132656238636135663134
      32356236666264346166636137366366383535353364313461656637646131393430363236373266
      32633630303032366338383336303262366639353563643436363234316232363064373336643839
      65323464623031396137616130653333366365633535353131366332633333393439333262626337
      31333139356436393962393335306561376464633466333239656435343531666433363438383138
      63613130653463383532386362666535653938306533346261323461316339623566386465373165
      37346235383739353232346536636637396364326135636332326236653461383532346239346239
      32636630356462363133
      """
  nginx_site_local_proxy_certificate_client_chain: vagrant_private_ca.inter_tls_ca_certificate
}
