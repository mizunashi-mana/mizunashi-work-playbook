import "mizunashi.work/pkg/roles/base"
import "mizunashi.work/pkg/roles/openssh_server"
import "mizunashi.work/pkg/roles/nftables"
import "mizunashi.work/pkg/roles/fail2ban"
import "mizunashi.work/pkg/roles/nginx"
import "mizunashi.work/pkg/roles/mastodon"
import "mizunashi.work/pkg/roles/nginx_exporter"
import "mizunashi.work/pkg/roles/prometheus"
import "mizunashi.work/pkg/roles/exim"
import "mizunashi.work/pkg/roles/nginx_site_http_redirector"
import "mizunashi.work/pkg/roles/nginx_site_mastodon_front"
import "mizunashi.work/pkg/roles/nginx_site_local_proxy"
import "mizunashi.work/pkg/roles/nginx_site_private_ca"
import "mizunashi.work/pkg/roles/postgresql_mastodon"
import "mizunashi.work/pkg/roles/private_mastodon_certificate"

#Schema: base
#Schema: fail2ban
#Schema: nftables
#Schema: openssh_server
#Schema: nginx
#Schema: mastodon
#Schema: exim
#Schema: nginx_exporter
#Schema: prometheus
#Schema: nginx_site_http_redirector
#Schema: nginx_site_mastodon_front
#Schema: nginx_site_local_proxy
#Schema: nginx_site_private_ca
#Schema: postgresql_mastodon
#Schema: private_mastodon_certificate

let ssh_port = 22
let http_port = 80
let https_port = 443
let local_proxy_https_port = 19100

let private_ca_inter_tls_certificate =
  """
  -----BEGIN CERTIFICATE-----
  MIIECTCCA7GgAwIBAgIBATAJBgcqhkjOPQQBMGExCzAJBgNVBAYTAkpQMQ4wDAYD
  VQQIDAVUb2t5bzEKMAgGA1UEBwwBLjEQMA4GA1UECgwHUHJpdmF0ZTEKMAgGA1UE
  CwwBLjEYMBYGA1UEAwwPUHJpdmF0ZSBSb290IENBMB4XDTIzMDMzMTE0NDIxNVoX
  DTI4MDMyOTE0NDIxNVowYDELMAkGA1UEBhMCSlAxDjAMBgNVBAgMBVRva3lvMQow
  CAYDVQQHDAEuMRAwDgYDVQQKDAdQcml2YXRlMQowCAYDVQQLDAEuMRcwFQYDVQQD
  DA5Qcml2YXRlIFRMUyBDQTCCAUswggEDBgcqhkjOPQIBMIH3AgEBMCwGByqGSM49
  AQECIQD/////AAAAAQAAAAAAAAAAAAAAAP///////////////zBbBCD/////AAAA
  AQAAAAAAAAAAAAAAAP///////////////AQgWsY12Ko6k+ez671VdpiGvGUdBrDM
  U7D2O848PifSYEsDFQDEnTYIhucEk2pmeOETnSa3gZ9+kARBBGsX0fLhLEJH+Lzm
  5WOkQPJ3A32BLeszoPShOUXYmMKWT+NC4v4af5uO5+tKfA+eFivOM1drMV7Oy7ZA
  aDe/UfUCIQD/////AAAAAP//////////vOb6racXnoTzucrC/GMlUQIBAQNCAARM
  fQw+IY5/tn73VeHuAclPdgjvVlSotim75mzSABfiHyY87ediXU1N04X37ZBg9uHt
  D6XMHOvjapce7vKltVxeo4IBZjCCAWIwHQYDVR0OBBYEFNkfAf8ZBbueu6iprD4G
  K/TQR0c2MHsGA1UdIwR0MHKhZaRjMGExCzAJBgNVBAYTAkpQMQ4wDAYDVQQIDAVU
  b2t5bzEKMAgGA1UEBwwBLjEQMA4GA1UECgwHUHJpdmF0ZTEKMAgGA1UECwwBLjEY
  MBYGA1UEAwwPUHJpdmF0ZSBSb290IENBggkAvcQrJW2Uwf0wRQYIKwYBBQUHAQEE
  OTA3MDUGCCsGAQUFBzAChilodHRwOi8vY2EtbG9jYWwubWl6dW5hc2hpLndvcmsv
  cm9vdENBLmNydDA6BgNVHR8EMzAxMC+gLaArhilodHRwOi8vY2EtbG9jYWwubWl6
  dW5hc2hpLndvcmsvcm9vdENBLmNybDASBgNVHRMBAf8ECDAGAQH/AgEAMA4GA1Ud
  DwEB/wQEAwIBhjAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwCQYHKoZI
  zj0EAQNHADBEAiBI6A0PCu87z3cHy+iFIS+u+k4btMvGFb6eOdNMRiPt2wIgazBz
  PmxaQRhZbrWIH9oNDltwoo/NGEL7Hb0LMUWtKz0=
  -----END CERTIFICATE-----
  """

#Schema & {
  base_workuser_name: "vagrant"

  mastodon_local_domain: "mstdn-local.mizunashi.work"
  mastodon_single_user_mode: "true"

  mastodon_db_user_password: {
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      65333663363039383963396135643335373032636437653730356635613734303434336534323136
      3135363037306231643964396337663435643266633566340a616137393839323333353332626462
      61383633343664306232393766613635303962303237626231333734313236646562626261386130
      3263663039376435390a383532326435363036646533393639356536626539333530343835653961
      30333436616561303861653761613238316162316430626664326662646135643737
      """
  }

  mastodon_secret_key_base: {
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      37323735323835666638353864626536386338613863303661353730646536393933363461383966
      6336356634633339333663626633333332613531303335360a396261366231393265646533323662
      30356632643331356139306366663836346663666465353766613435373330396464366530363933
      6537373534666665340a663637613064373063363437653433663365393161643538306537316664
      62386238663461633337623834633333393533636539373862303430396434616232353261303535
      66343935303935333730376362313135353265326565303864393664326235353535373235316365
      35363361623862323937633534383634343131303365623737343435363337656161363634386138
      38306135346363316432663163353565353930366462373131646264373930303964636165653530
      36303465343339366666613431323330396666373533666331646334613231346264356164636265
      37656131303933383936636166323733346130356635343839663336376136303336353662633637
      313237396237633536333036346435313630
      """
  }
  mastodon_otp_secret: {
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      35653533633464366161633961323035323261643130386638626237346261643763346464613933
      3832646163646264303434626237386533666638383336660a353939396531646333643065393263
      61626465323632633233346132646265346635616561636536376430323932373661343132623261
      3565613431656666620a363431626161303466383235366432393734323961666331306532616366
      35613137323564303033636530616239336133373361616165316131663934646661336666343031
      64653463373336386639333331396431316135313139636630386435316265366139363361656537
      39636161336439383239313532333363373565396364663461636532303035336461643635633165
      33333133653561363334356530333335663932623061366366616262306263626539636132393133
      38376363333334663861623962643166326538616534616338643833613365336639396130616465
      62393836353437303237393465633633663934613130316532386532333064386538366439656134
      386263386436623762363665373966386436
      """
  }

  mastodon_vapid_private_key: {
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      34633130343535333432333436613738373337356433336238616161313239376530383663366130
      3732656338646634656263636632616461663136336234390a356665633565653131343937326330
      61646133633061323164376165666231393234373266643836656561663838393735393738303037
      6665306434633234340a306362396535306464386232333332633739366139383430366266343930
      65333436343931616230393361653234376438313764333937616330353464373132373861356465
      3565323135626462313931613335633363643938396262373962
      """
  }
  mastodon_vapid_public_key: "BMRVNeG8Io07OP2yGLhhhIXiX-m7Tjjhws_RJ9b1BvBXTKj8wRn9XAyRBoeM04TUgj26qkdnrtBbcRh_XODZW3k="

  openssh_server_listen_port: ssh_port
  nginx_site_http_redirector_listen_port: http_port
  nginx_site_mastodon_front_listen_port: https_port
  nginx_site_local_proxy_listen_port: local_proxy_https_port

  nftables_accept_tcp_ports: [
    ssh_port,
    http_port,
    https_port,
  ]

  nginx_resolver: "8.8.8.8"

  exim_mail_domain: "mail-local.mizunashi.work"

  nginx_site_local_proxy_common_domain: "mizunashi.private"
  nginx_site_local_proxy_entries: {}

  nginx_site_private_ca_domain: "ca-local.mizunashi.work"
  nginx_site_private_ca_listen_port: http_port

  prometheus_scrape_configs: [
    {
      job_name: "node"
      static_configs: [
        {
          targets: [
            "localhost:9100"
          ]
          labels: {
            "service": "vagrant"
            "project": "primary"
            "hostname": "localhost"
          }
        }
      ]
    },
    {
      job_name: "nginx"
      static_configs: [
        {
          targets: [
            "localhost:9113"
          ]
          labels: {
            "service": "vagrant"
            "project": "primary"
            "hostname": "localhost"
          }
        }
      ]
    },
    {
      job_name: "redis"
      static_configs: [
        {
          targets: [
            "localhost:9121"
          ]
          labels: {
            "service": "vagrant"
            "project": "primary"
            "hostname": "localhost"
          }
        }
      ]
    },
  ]

  private_mastodon_certificate_fullchain:
    """
    -----BEGIN CERTIFICATE-----
    MIIEJzCCA86gAwIBAgIBATAJBgcqhkjOPQQBMGAxCzAJBgNVBAYTAkpQMQ4wDAYD
    VQQIDAVUb2t5bzEKMAgGA1UEBwwBLjEQMA4GA1UECgwHUHJpdmF0ZTEKMAgGA1UE
    CwwBLjEXMBUGA1UEAwwOUHJpdmF0ZSBUTFMgQ0EwHhcNMjMwMzMxMTUyMDMwWhcN
    MjQwMzMwMTUyMDMwWjBsMQswCQYDVQQGEwJKUDEOMAwGA1UECAwFVG9reW8xCjAI
    BgNVBAcMAS4xEDAOBgNVBAoMB1ByaXZhdGUxCjAIBgNVBAsMAS4xIzAhBgNVBAMM
    Gm1zdGRuLWxvY2FsLm1penVuYXNoaS53b3JrMIIBSzCCAQMGByqGSM49AgEwgfcC
    AQEwLAYHKoZIzj0BAQIhAP////8AAAABAAAAAAAAAAAAAAAA////////////////
    MFsEIP////8AAAABAAAAAAAAAAAAAAAA///////////////8BCBaxjXYqjqT57Pr
    vVV2mIa8ZR0GsMxTsPY7zjw+J9JgSwMVAMSdNgiG5wSTamZ44ROdJreBn36QBEEE
    axfR8uEsQkf4vOblY6RA8ncDfYEt6zOg9KE5RdiYwpZP40Li/hp/m47n60p8D54W
    K84zV2sxXs7LtkBoN79R9QIhAP////8AAAAA//////////+85vqtpxeehPO5ysL8
    YyVRAgEBA0IABNNMM5IqklV47yfbJffdAXFq0EhDITCKVWHx6OtHqMSbd2mpoD2a
    6G+Y/iv0rJEz7HMFXkVNfw3VtAZESEbnjSWjggF4MIIBdDAdBgNVHQ4EFgQUOMIa
    GWgogUXKH+o9AshoV9N+dogwgYsGA1UdIwSBgzCBgIAU2R8B/xkFu567qKmsPgYr
    9NBHRzahZaRjMGExCzAJBgNVBAYTAkpQMQ4wDAYDVQQIDAVUb2t5bzEKMAgGA1UE
    BwwBLjEQMA4GA1UECgwHUHJpdmF0ZTEKMAgGA1UECwwBLjEYMBYGA1UEAwwPUHJp
    dmF0ZSBSb290IENBggEBMAkGA1UdEwQCMAAwDgYDVR0PAQH/BAQDAgeAMB0GA1Ud
    JQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjBKBggrBgEFBQcBAQQ+MDwwOgYIKwYB
    BQUHMAKGLmh0dHA6Ly9jYS1sb2NhbC5taXp1bmFzaGkud29yay9pbnRlckNBX1RM
    Uy5jcnQwPwYDVR0fBDgwNjA0oDKgMIYuaHR0cDovL2NhLWxvY2FsLm1penVuYXNo
    aS53b3JrL2ludGVyQ0FfVExTLmNybDAJBgcqhkjOPQQBA0gAMEUCIHngKz5fajdw
    52Nfov1KiKUBmbNI3EDoM6miG0enLQDtAiEA8IeZNsm9iosbhUAoDg5SVqUuBtZX
    CmWHAS7dlLAe99o=
    -----END CERTIFICATE-----
    \(private_ca_inter_tls_certificate)
    """
  private_mastodon_certificate_chain: private_ca_inter_tls_certificate
  private_mastodon_certificate_privkey:
    "__ansible_vault":
      """
      $ANSIBLE_VAULT;1.1;AES256
      64313936386334346265623966323639346664346437373638363030656634633239393366303562
      3330616365636166613137663063636634653663393033370a376562306238636165623535336661
      36333163623837313561633564636432306337653731343830363735643763343365656464376561
      6162306666663064300a373430336139323165393239366362666239393135303036373566393235
      33613239643039366132366637333664363239623362656465643234303461623032396331616530
      61643939666464326165653037323665623965346562636137643266613266613133323565386566
      36663733303635336138383930316134353233616330656135373562326133313861326464626233
      62353965613132313963353663316537353065663031346531656135633639623932363431396137
      66393235333361353130383637633266313236366561633731313930393162633038343331363231
      64346430653664363038393331303865656163616362643961396665663231303362666333646436
      32666335316232623263313732306264636531353832636462326532613766396565383562316661
      64336530663536306261363765373765363830393063326139373730643830303033313963653133
      34653963363331633631336531383037386561616531333561663038623232613866386361613864
      37616137613165336534663165303730653339386333356631663030366561343033373939643063
      39633335636239316236383636376334353235303338326130306333656633353564613632343335
      30343538613930373964376564306464313961333532656432363237343435663932353131613363
      61343032313063313734383962346532643732396463333838333232306462323635653933646264
      36353536386664366131393236333432346166316363383365393937306437373431346139393436
      61633263326664653564666430316162313636386166303562353830616134353366383534656664
      39656639396530303066343038623631613164633331373338333466336331366233666232323936
      63646232363933343433363038323565623765323264333331316336353238396130383461376161
      31613665643761333666366566343465633965636461343833396631663934396239656530313462
      61393066653138396133326164663634373666336534616663306439616265373830633062336230
      33643961633036306563356639633333303462363664343734353737303436306139343534343866
      37346163323634643166653765313330626563633662363030353763613835616431656538656633
      38386462313563396536313364336137666361313837626166643939343438353563656639333637
      38616432376631663034313633326637353234393366353261646363306664316538623236383139
      31346665336132633138343534373038646134306364333335666431333832666266303839303536
      35353365356665343763623830373336303361376534646364643932636536313363633865643961
      34656465333637383066353861383035663632663663303964373365326464356666356165613330
      34663362633532343238333031363036356333643564613832643361316133623038366361653965
      64653832333865666537323563616465326130646638366264393033373733393933613932326437
      6166
      """

  nginx_site_private_ca_root_certificate:
    """
    -----BEGIN CERTIFICATE-----
    MIICpzCCAkwCCQC9xCslbZTB/TAKBggqhkjOPQQDAjBhMQswCQYDVQQGEwJKUDEO
    MAwGA1UECAwFVG9reW8xCjAIBgNVBAcMAS4xEDAOBgNVBAoMB1ByaXZhdGUxCjAI
    BgNVBAsMAS4xGDAWBgNVBAMMD1ByaXZhdGUgUm9vdCBDQTAeFw0yMzAzMzExNDQy
    MDJaFw0zMzAzMjgxNDQyMDJaMGExCzAJBgNVBAYTAkpQMQ4wDAYDVQQIDAVUb2t5
    bzEKMAgGA1UEBwwBLjEQMA4GA1UECgwHUHJpdmF0ZTEKMAgGA1UECwwBLjEYMBYG
    A1UEAwwPUHJpdmF0ZSBSb290IENBMIIBSzCCAQMGByqGSM49AgEwgfcCAQEwLAYH
    KoZIzj0BAQIhAP////8AAAABAAAAAAAAAAAAAAAA////////////////MFsEIP//
    //8AAAABAAAAAAAAAAAAAAAA///////////////8BCBaxjXYqjqT57PrvVV2mIa8
    ZR0GsMxTsPY7zjw+J9JgSwMVAMSdNgiG5wSTamZ44ROdJreBn36QBEEEaxfR8uEs
    Qkf4vOblY6RA8ncDfYEt6zOg9KE5RdiYwpZP40Li/hp/m47n60p8D54WK84zV2sx
    Xs7LtkBoN79R9QIhAP////8AAAAA//////////+85vqtpxeehPO5ysL8YyVRAgEB
    A0IABDnVn19WvI+0lhLh/Y7NAluEf96h/hkN73+29mqwHNONVypW3xuT25tcX1RY
    V1pDrb05sw6Pj11p9DqZqDtTke0wCgYIKoZIzj0EAwIDSQAwRgIhAO0N3Xu5U6lD
    eShc12LDCEOfTzjxI7m0CW2Rs1F4FXOiAiEAtK7LE8AxeZ3Fx24eifauwfsRCWeL
    3+HQK2SFF1uHYuc=
    -----END CERTIFICATE-----
    """
  nginx_site_private_ca_root_crl:
    """
    -----BEGIN X509 CRL-----
    MIH4MIGfAgEBMAkGByqGSM49BAEwYTELMAkGA1UEBhMCSlAxDjAMBgNVBAgMBVRv
    a3lvMQowCAYDVQQHDAEuMRAwDgYDVQQKDAdQcml2YXRlMQowCAYDVQQLDAEuMRgw
    FgYDVQQDDA9Qcml2YXRlIFJvb3QgQ0EXDTIzMDMzMTE1MzAxMFoXDTIzMDQzMDE1
    MzAxMFqgDjAMMAoGA1UdFAQDAgEBMAkGByqGSM49BAEDSQAwRgIhAPyzOBEOeL0w
    gDAprxPp66ZD9V+JIFnGBCyRcC+DnGrNAiEAhlgJea+Gs7JiMRHysNT6QMSob6wS
    zrv9ObBQX0WRWN8=
    -----END X509 CRL-----
    """

  nginx_site_private_ca_inter_tls_certificate: private_ca_inter_tls_certificate
  nginx_site_private_ca_inter_tls_crl:
    """
    -----BEGIN X509 CRL-----
    MIH2MIGeAgEBMAkGByqGSM49BAEwYDELMAkGA1UEBhMCSlAxDjAMBgNVBAgMBVRv
    a3lvMQowCAYDVQQHDAEuMRAwDgYDVQQKDAdQcml2YXRlMQowCAYDVQQLDAEuMRcw
    FQYDVQQDDA5Qcml2YXRlIFRMUyBDQRcNMjMwMzMxMTUzMDMxWhcNMjMwNDMwMTUz
    MDMxWqAOMAwwCgYDVR0UBAMCAQEwCQYHKoZIzj0EAQNIADBFAiEAh6YzsH2ufW0N
    Ta6YuBQtdpTHi/Xsd+MywUVDgVP7YKACIFKH9ia+smlz+vw+RaK2ZE4ZJz/+bvSc
    9Cruavkz3IoK
    -----END X509 CRL-----
    """
}
