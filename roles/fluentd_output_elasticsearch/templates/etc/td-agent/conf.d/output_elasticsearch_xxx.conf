<match {{ item }}>
  @type elasticsearch

  scheme {{ fluentd_output_elasticsearch_scheme }}
  host {{ fluentd_output_elasticsearch_domain }}
  port {{ fluentd_output_elasticsearch_port }}
  ca_file {{ fluentd_output_elasticsearch_ca_file }}

  user {{ fluentd_output_elasticsearch_user_name }}
  password {{ fluentd_output_elasticsearch_user_password }}

  logstash_format true
  logstash_prefix fluentd-{{ item }}-#{Socket.gethostname}

  <buffer>
    @type file
    path /var/log/td-agent/buffer/{{ item }}

    total_limit_size 512m

    retry_type exponential_backoff
    retry_max_times 2
    retry_max_interval 30

    timekey 60s
    timekey_wait 0s
    timekey_use_utc true

    overflow_action drop_oldest_chunk
  </buffer>
</match>
