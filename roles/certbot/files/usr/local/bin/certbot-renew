#!/usr/bin/env bash

set -euxo

if [ -n "$REQUESTS_CA_BUNDLE" ]; then
  export REQUESTS_CA_BUNDLE="$REQUESTS_CA_BUNDLE"
fi

case "${HOOK_TYPE:-}" in
  'nginx' )
    POST_HOOK="systemctl reload nginx"
    ;;
esac

CERTBOT_REWEW_ARGS=(
  --cert-name "$DOMAIN"
)
if [ -n "${PRE_HOOK:-}" ]; then
  CERTBOT_REWEW_ARGS+=(--pre-hook "$PRE_HOOK")
fi
if [ -n "${POST_HOOK:-}" ]; then
  CERTBOT_REWEW_ARGS+=(--post-hook "$POST_HOOK")
fi

certbot renew "${CERTBOT_RENEW_ARGS[@]}"

CERT_DIR="/etc/letsencrypt/live/$DOMAIN"

/usr/local/bin/node_exporter_custom_collector -c 'echo' \
  -d "$DESTINATION_PROMFILE"
