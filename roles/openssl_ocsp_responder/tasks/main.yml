---
- name: Install openssl
  ansible.builtin.apt:
    name: 'openssl={{ openssl_version }}*'
    state: present
  become: true

- name: Add ocsp-responder user
  ansible.builtin.user:
    name: ocsp-responder
    system: true
    home: /var/lib/ocsp-responder
    shell: /usr/sbin/nologin
    state: present
  become: true

- name: Directories of OCSP entries are available
  ansible.builtin.file:
    path: '/var/lib/ocsp-responder/{{ item }}'
    state: directory
    owner: ocsp-responder
    group: ocsp-responder
    mode: '0755'
  become: true
  loop: '{{ openssl_ocsp_responder_entries|dict2items|map(attribute="key") }}'

- name: Copy database contents
  ansible.builtin.copy:
    content: "{{ openssl_ocsp_responder_entries[item].ca_database_content }}\n"
    dest: '/var/lib/ocsp-responder/{{ item }}/index.txt'
    owner: ocsp-responder
    group: ocsp-responder
    mode: '0644'
    backup: true
  become: true
  loop: '{{ openssl_ocsp_responder_entries|dict2items|map(attribute="key") }}'
  notify:
    - Restart openssl-ocsp-responder

- name: Copy certificates
  ansible.builtin.copy:
    content: "{{ openssl_ocsp_responder_entries[item].ca_cert }}\n"
    dest: '/var/lib/ocsp-responder/{{ item }}/cacert.pem'
    owner: ocsp-responder
    group: ocsp-responder
    mode: '0644'
    backup: true
  become: true
  loop: '{{ openssl_ocsp_responder_entries|dict2items|map(attribute="key") }}'
  notify:
    - Restart openssl-ocsp-responder

- name: Copy private keys
  ansible.builtin.copy:
    content: "{{ openssl_ocsp_responder_entries[item].ca_privkey }}\n"
    dest: '/var/lib/ocsp-responder/{{ item }}/privkey.pem'
    owner: ocsp-responder
    group: ocsp-responder
    mode: '0600'
    backup: true
  become: true
  loop: '{{ openssl_ocsp_responder_entries|dict2items|map(attribute="key") }}'
  no_log: true
  notify:
    - Restart openssl-ocsp-responder

- name: Install entrypoint
  ansible.builtin.copy:
    src: usr/bin/openssl-ocsp-responder
    dest: /usr/bin/openssl-ocsp-responder
    owner: root
    group: root
    mode: '0755'
    backup: true
  become: true
  notify:
    - Restart openssl-ocsp-responder

- name: Install sysconfig
  ansible.builtin.template:
    src: etc/default/openssl-ocsp-responder-xxx
    dest: '/etc/default/openssl-ocsp-responder-{{ item }}'
    owner: root
    group: root
    mode: '0644'
    backup: true
  become: true
  loop: '{{ openssl_ocsp_responder_entries|dict2items|map(attribute="key") }}'
  notify:
    - Restart openssl-ocsp-responder

- name: Install services
  ansible.builtin.template:
    src: etc/systemd/system/openssl-ocsp-responder-xxx.service
    dest: '/etc/systemd/system/openssl-ocsp-responder-{{ item }}.service'
    owner: root
    group: root
    mode: '0644'
    backup: true
  become: true
  loop: '{{ openssl_ocsp_responder_entries|dict2items|map(attribute="key") }}'
  notify:
    - Restart openssl-ocsp-responder

- name: Notify restart service if not started
  ansible.builtin.command: systemctl status 'openssl-ocsp-responder-{{ item }}'
  register: openssl_ocsp_responder_service_status
  changed_when: openssl_ocsp_responder_service_status.rc != 0
  failed_when: false
  become: true
  loop: '{{ openssl_ocsp_responder_entries|dict2items|map(attribute="key") }}'
  notify:
    - Restart openssl-ocsp-responder
