#!/usr/bin/env bash

[ "$TRACE" = 'true' ] && set -x
set -euo pipefail

atexit() {
  [ -n "${TMPFILE:-}" ] && rm -rf "$TMPFILE"
}

trap atexit EXIT
trap atexit SIGTERM

FILENAME="$1"
TMPFILE="$(mktemp "/tmp/$(basename "$0").tmp.XXXXXX")"

sed \
  "s|error_log /var/log/nginx/error.log;|error_log /var/log/nginx/error.log;include $FILENAME;|" \
  /etc/nginx/nginx.conf \
  | cat "$TMPFILE"

nginx -t -c "$TMPFILE"
