<source>
  @type tail
  path /var/log/kern.log
  pos_file /var/log/td-agent/{{ fluentd_input_kern_log_raw_tag }}.pos
  tag {{ fluentd_input_kern_log_raw_tag }}

  <parse>
    @type regexp
    expression /^(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[^ :\[]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)?(?: \[ *(?<elapsed>[0-9.]+)\])? *(?<message>.*)$/
    time_format "%b %d %H:%M:%S"
  </parse>
</source>

<match {{ fluentd_input_kern_log_raw_tag }}>
  @type rewrite_tag_filter

  <rule>
    key     message
    pattern /^\[NFTABLES.+\]: IN=/
    tag     {{ fluentd_input_kern_log_nftables_tag }}
  </rule>
  <rule>
    key     message
    pattern /.*/
    tag     {{ fluentd_input_kern_log_tag }}
  </rule>
</match>

<filter {{ fluentd_input_kern_log_nftables_tag }}>
  @type parser
  key_name message

  reserve_time true
  reserve_data true
  remove_key_name_field true

  <parse>
    @type regexp
    expression /^\[NFTABLES (?<logtype>.+)\]: *(?<logbody>.*)$/
  </parse>
</filter>

<filter {{ fluentd_input_kern_log_nftables_tag }}>
  @type parser
  key_name logbody

  reserve_time true
  reserve_data true
  remove_key_name_field true

  <parse>
    @type ltsv_lack
    delimiter " "
    label_delimiter "="
  </parse>
</filter>
